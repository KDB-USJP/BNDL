<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BNDL Viewer (v1.2+ groups/expose/setuser)</title>
<style>
  :root{
    --bg:#2b2b2b; --panel:#1f232b; --border:#2b3442; --text:#e6e6e6; --muted:#aeb6c2;
    --row-max: 1100px; --cardw: clamp(260px, 34vw, 460px);
    --col-geometry:#6cc26c; --col-vector:#4aaadf; --col-float:#9aa3ad; --col-int:#e59f4a;
    --col-bool:#4cd089; --col-color:#f6d06b; --col-string:#c678dd; --col-material:#d16a6a; --col-unknown:#7d8590;
    --node-body:#393f4a; --wire:#6b8f6b; --shadow:0 8px 18px rgba(0,0,0,.35); --node-shadow:0 4px 8px rgba(0,0,0,.35);
    --accent:#6aa9ff; --step-pill-bg:#0f131a; --step-pill-fg:#d9dee6;
    --btn-bg: linear-gradient(180deg, #2a3240, #1e2530); --btn-border: #2e3a49;
    --btn-hover: linear-gradient(180deg, #324052, #242d3a); --btn-active: linear-gradient(180deg, #1f2630, #1a2029); --btn-focus: #6aa9ff77;
  }
  .theme-light{
    --bg:#e6e6e6; --panel:#f5f5f5; --border:#c8cfd6; --text:#1f232b; --muted:#526070;
    --node-body:#e9edf3; --wire:#7aa37a; --shadow:0 10px 18px rgba(0,0,0,.12); --node-shadow:0 6px 12px rgba(0,0,0,.12);
    --step-pill-bg:#e3e7ee; --step-pill-fg:#2a3442;
    --btn-bg: linear-gradient(180deg, #ffffff, #f0f3f8); --btn-border:#cbd3dd;
    --btn-hover: linear-gradient(180deg, #ffffff, #e9eef6); --btn-active: linear-gradient(180deg, #f2f5fb, #e5ebf5); --btn-focus: #6aa9ff55;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(100%) blur(6px);
    background:color-mix(in oklab, var(--bg) 86%, transparent); border-bottom:1px solid var(--border); padding:12px 24px;}
  h1{margin:0 0 6px 0; font-size:22px}
  .muted{color:var(--muted)}
  .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .btn{position:relative;background:var(--btn-bg);color:var(--text);border:1px solid var(--btn-border);border-radius:12px;
    padding:10px 14px;cursor:pointer;transition:transform .06s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease, color .15s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06); outline: none;}
  .btn:hover{ background:var(--btn-hover); box-shadow: 0 6px 14px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08); transform: translateY(-1px); }
  .btn:active{ background:var(--btn-active); transform: translateY(0); box-shadow: 0 3px 8px rgba(0,0,0,.22) inset; }
  .btn:focus-visible{ box-shadow: 0 0 0 3px var(--btn-focus), 0 6px 14px rgba(0,0,0,.28); }
  input[type=file]{margin-left:auto}
  main{padding:16px 24px 80px}
  .err{border:1px solid #7a2b2b; border-radius:12px; padding:12px; margin:12px 0;
    background:linear-gradient(180deg, #3a1f1f, #311818); color:#ffdddd; box-shadow: var(--shadow);}
  .err h3{margin:0 0 6px 0; font-size:15px}
  .err ul{margin:6px 0 0 18px}
  .err code{background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08); padding:1px 6px; border-radius:6px; color:#ffe8e8;}
  textarea{width:100%;height:220px;resize:vertical;background:var(--panel);color:var(--text);
    border:1px solid var(--border);border-radius:12px;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}
  .section-title{margin:18px 0 8px;font-size:18px}
  details.block{background:var(--panel);border:1px solid var(--border);border-radius:12px;margin:10px 0;padding:10px 12px}
  details.block>summary{cursor:pointer;font-weight:600;list-style:none}
  details.block>summary::-webkit-details-marker{display:none}
  ol.steps{counter-reset: step}
  li.step{position:relative; list-style:none; margin:28px 0; padding-left:96px; transition:opacity .2s ease, outline-color .2s; min-height:72px;}
  li.step::before{counter-increment: step; content: counter(step); position:absolute; left:16px; top:50%; transform:translateY(-50%);
    width:56px; height:56px; display:grid; place-items:center; font-size:20px; font-weight:800; color:var(--step-pill-fg);
    background:var(--step-pill-bg); border-radius:14px; box-shadow:0 6px 14px rgba(0,0,0,.35);}
  .step-desc{margin:0 0 8px 0; font-size:16px; font-weight:600; color:#e8eefc} .theme-light .step-desc{color:#0e1522}
  .card{border:1px solid var(--border); border-radius:14px; padding:12px; margin-top:8px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.06)); box-shadow: var(--shadow);}
  .row{position:relative; display:grid; grid-template-columns:1fr auto 1fr; gap:12px; align-items:center; max-width:var(--row-max); margin-inline:auto;}
  .spacer{min-width:40px}
  .wire-layer{ position:absolute; inset:0; pointer-events:none; }
  .wire-layer line{ stroke-width:4; stroke-linecap:round; }
  .node{width:var(--cardw); border-radius:14px; overflow:hidden; position:relative; box-shadow: var(--node-shadow);}
  .hdr{ padding:10px 12px; font-weight:700; color:#fff; } .theme-light .hdr{ color:#0b0f15; }
  .body{ background:var(--node-body); padding:10px 12px; border-top:1px solid rgba(0,0,0,.25); }
  .ports{ display:flex; justify-content:space-between; gap:12px; margin-top:6px; }
  .ports .left,.ports .right{ display:flex; flex-direction:column; gap:6px } .ports .right{ align-items:flex-end }
  .port{ display:inline-flex; align-items:center; gap:8px; width:max-content; padding:4px 8px; font-size:12px; background:rgba(0,0,0,.15);
    border:1px solid rgba(0,0,0,.25); border-radius:999px; color:#fff }
  .theme-light .port{ color:#18202a; background:rgba(0,0,0,.05); border-color:rgba(0,0,0,.12) }
  .dot{ width:10px;height:10px;border-radius:50%; background:var(--col-unknown) }
  .float{background:var(--col-float)} .int{background:var(--col-int)} .vector{background:var(--col-vector)}
  .geometry{background:var(--col-geometry)} .bool{background:var(--col-bool)} .color{background:var(--col-color)}
  .string{background:var(--col-string)} .material{background:var(--col-material)}
  .kv{display:grid; grid-template-columns:max-content 1fr; gap:6px 10px; margin-top:10px; max-width:var(--row-max); margin-inline:auto}
  /* Collapsible "Node value settings — …" header */
  .kv-collapsible{border:1px solid var(--border); border-radius:10px; background:var(--panel); padding:8px 10px; margin-top:8px}
  .kv-collapsible>summary{cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px; font-weight:600}
  .kv-collapsible>summary::-webkit-details-marker{display:none}
  .kv-collapsible .kv-title{flex:1}
  .kv-collapsible .kv-count{font-size:12px; color:var(--muted)}

  /* Collapsible scroller for large key/value sets */
  .kv-wrap{position:relative}
  .kv.scrolled{max-height:280px; overflow:auto; padding-right:6px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,.08)}
  .theme-light .kv.scrolled{background:rgba(0,0,0,.04)}
  .kv-fade{position:absolute; left:0; right:0; bottom:42px; height:48px;
    background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.18)); pointer-events:none}
  .theme-light .kv-fade{background:linear-gradient(180deg, rgba(255,255,255,0), rgba(0,0,0,.08))}
  .kv-controls{display:flex; justify-content:flex-end; gap:8px; margin-top:8px}
  .mini-btn{background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--text);
    font-size:12px; padding:6px 10px; border-radius:999px; cursor:pointer}
  .mini-btn:hover{background:var(--btn-hover)}
  .kv-summary{font-size:12px; color:var(--muted); margin-right:auto; align-self:center}
  .key{color:var(--muted)}
  .val{background:rgba(0,0,0,.15); border:1px solid var(--border); border-left:4px solid var(--col-float);
       border-radius:8px;padding:3px 8px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .theme-light .val{ background:#fff }
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .chip{background:rgba(0,0,0,.15); border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; color:#fff}
  .directive{margin:12px 0 4px; padding:10px 12px; border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.06)); border-radius:10px; display:flex; align-items:flex-start; gap:10px; box-shadow: var(--shadow); }
  .directive .icon{font-weight:900; font-size:16px; line-height:1; margin-top:2px; color:#f3d37a}
  .directive .text{font-weight:600}
  details#srcWrap{ margin-top:8px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:8px 10px; }
  details#srcWrap>summary{ cursor:pointer; font-weight:600; list-style:none; display:flex; align-items:center; gap:.5rem; }
  details#srcWrap>summary::-webkit-details-marker{ display:none; }
  details#srcWrap[open]{ box-shadow: var(--shadow); }
  .fab{ position:fixed; right:18px; bottom:18px; z-index:20; background:var(--panel); color:var(--text);
    border:1px solid var(--border); border-radius:999px; padding:10px 12px; box-shadow: var(--shadow); cursor:pointer;}
  @media (max-width: 900px){
    :root{ --cardw: 100%; }
    .row{ grid-template-columns: 1fr; grid-auto-rows: auto; gap: 16px; }
    .node{ width: var(--cardw); }
    .spacer{ height: 16px; width:0 !important; }
    .wire-layer line{ stroke-opacity: .7; }
  }
</style>
</head>
<body>
  <header>
    <h1>BNDL Viewer</h1>
    <div class="muted">Paste a BNDL (v1.2+). Now supports: <code>START/END GROUP NAMED …</code>, <code>Expose …</code>, <code>SetUser …</code>, <code>§ … § to …</code> in Set-blocks, <code>Declare …</code>, and dotted <code>Connect⋯</code>.</div>
    <div class="controls">
      <button class="btn" id="parseBtn">Parse</button>
      <button class="btn" id="toggleTheme">Dark Mode</button>
      <button class="btn" id="toggleAll">Collapse All</button>
      <div style="display:flex;gap:.5rem;">
        <button class="btn" id="ptToggle">Playthrough: Off</button>
        <button class="btn" id="ptPrev">⟵ Prev</button>
        <button class="btn" id="ptNext">Next ⟶</button>
        <button class="btn" id="ptReset">Reset</button>
      </div>
      <input class="btn" style="padding:8px" type="file" id="fileInput" accept=".txt" />
    </div>
  </header>

  <main>
    <div class="muted">BNDL source (expand to view / edit)</div>
    <details id="srcWrap" open>
      <summary>Show / Hide BNDL source</summary>
      <textarea id="src" placeholder="Paste the exported build description here..."></textarea>
    </details>
    <div id="output"></div>
  </main>

  <button class="fab" id="toTop">▲ Top</button>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const out = $('#output'), src = $('#src'), srcWrap = $('#srcWrap');

  /* ---- Small UI helpers ---- */
  const isLight = () => document.documentElement.classList.contains('theme-light');
  $('#toggleTheme').addEventListener('click', () => {
    const cl = document.documentElement.classList;
    cl.toggle('theme-light');
    $('#toggleTheme').textContent = cl.contains('theme-light') ? 'Light Mode' : 'Dark Mode';
    requestAnimationFrame(() => document.querySelectorAll('.row').forEach(drawWireForRow));
  });
  $('#toggleAll').addEventListener('click', () => {
    document.querySelectorAll('details.block').forEach(d => d.open = !d.open);
    requestAnimationFrame(() => document.querySelectorAll('.row').forEach(drawWireForRow));
  });
  $('#toTop').addEventListener('click', () => scrollTo({top:0, behavior:'smooth'}));

  /* ---- Colors ---- */
  const headerColorsDark = {
    'Group Input':'#2e8db5','Group Output':'#2e8db5','Group':'#2e8db5',
    'Math':'#d08d2e','Vector Math':'#d08d2e','Boolean Math':'#d08d2e','Compare':'#d08d2e',
    'Set Position':'#8b6df3','Position':'#6aa9ff','Separate XYZ':'#6aa9ff','Combine XYZ':'#6aa9ff',
    'Random Value':'#9f7aea','Capture Attribute':'#8b6df3','Separate Geometry':'#4ab08b',
    'Raycast':'#5db1d1','Image Texture':'#d16a6a','Set Material':'#d16a6a',
    'Object Info':'#4aaadf','Collection Info':'#4aaadf',
    'Instance on Points':'#4ab08b','Join Geometry':'#6cc26c','Realize Instances':'#6cc26c',
    'Curve to Mesh':'#6aa9ff','Curve Circle':'#6aa9ff','Curve Line':'#6aa9ff',
    'Subdivide Mesh':'#6cc26c','Mesh to Volume':'#6aa9ff','Distribute Points in Volume':'#6cc26c',
    'Index Switch':'#6aa9ff','Vector Math':'#6aa9ff','Float Curve':'#6aa9ff','Delete Geometry':'#e59f4a'
  };
  const headerColorsLight = {...headerColorsDark};
  const headerColor = type => (isLight()? headerColorsLight[type] : headerColorsDark[type]) || (isLight() ? '#6aa9ff' : '#3a83a6');

  const colVar = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  const socketColor = (type) => {
    const map = {geometry:'--col-geometry', vector:'--col-vector', float:'--col-float', int:'--col-int', bool:'--col-bool', color:'--col-color', string:'--col-string', material:'--col-material', unknown:'--col-unknown'};
    return colVar(map[type] || '--col-unknown') || '#7d8590';
  };

  /* ----------------------------------------------------------------
     BNDL PARSER — v1.2+ aware
     - Groups: START/END GROUP NAMED …
     - Create … ; type=…
     - Declare Inputs/Outputs
     - Expose […] ○/⦿ …
     - Set […] : with § … § to …  (and legacy # … # to …)
     - SetUser […] :
     - Adjust
     - Rename
     - Connect / Connect⋯
  ------------------------------------------------------------------*/
  function parseBNDL(text){
    const L = text.replace(/\r\n?/g, '\n').split('\n');

    const nodes = new Map();
    const steps = [];
    const links = [];
    const declares = [];
    const zones = [];
    const errors = [];

    // Helpers
    const trimTildes = s => s?.replace(/^~\s*|\s*~$/g,'').trim();
    const unquote = s => s?.replace(/^©|©$/g,''); // UI enum strings
    const parseAngleBrackets = s => s?.replace(/^<|>$/g,'');
    const parseTuple = s => s?.replace(/^<|>$/g,'').split(/\s*,\s*/).map(x => isNaN(+x)? x : +x);
    const idKey = id => `#${id}`;

    // Regexes
    const R_GROUP_START = /^START\s+GROUP\s+NAMED\s+(.+?)\s*$/i;
    const R_GROUP_END   = /^END\s+GROUP\s+NAMED\s+(.+?)\s*$/i;

    const R_CREATE = /^Create\s+\[\s*([^|\]]+?)\s*\|\s*([^|\]]*?)\s*\|\s*\]\s*~\s*(.*?)\s*~\s*#(\d+)\s*;\s*type=([A-Za-z0-9_]+)\s*$/;
    const R_DECLARE = /^(Declare\s+(Inputs|Outputs))\s+\[\s*(.+?)\s+#(\d+)\s*\]\s*:\s*(.+)$/;
    const R_EXPOSE = /^Expose\s+\[\s*(.+?)\s+#(\d+)\s*\]\s+(○|⦿)\s+(.+?)\s*$/;
    const R_RENAME = /^Rename\s+\[\s*(.+?)\s+#(\d+)\s*\]\s+to\s+~\s*(.*?)\s*~\s*$/;
    const R_SET_HDR = /^Set\s+\[\s*(.+?)\s+#(\d+)\s*\]\s*:\s*$/;
    const R_SETUSER_HDR = /^SetUser\s+\[\s*(.+?)\s+#(\d+)\s*\]\s*:\s*$/;
    // Accept either "§ key § to value" or legacy "# key # to value"
    const R_SET_ITEM = /^(?:§|#)\s*(.+?)\s*(?:§|#)\s*to\s*(.+?)\s*$/;
    const R_ADJUST  = /^Adjust\s+\[\s*(.+?)\s+#(\d+)\s*\]\s+\#\s*(.+?)\s*\#\s*to\s*(.+?)\s*$/;
    const R_CONNECT = /^Connect(⋯)?\s+\[\s*(.+?)\s+#(\d+)\s*\]\s+○\s+(.+?)\s+to\s+\[\s*(.+?)\s+#(\d+)\s*\]\s+⦿\s+(.+?)\s*$/;

    function ensureNode(ui, id){
      const key = idKey(id);
      if (!nodes.has(key)) nodes.set(key, { uiLabel:ui, variant:'', customLabel:'', typeId:'', sockets:{in:[],out:[]}, sets:[], setUser:[], adjust:[], nameForUI: ui });
      return nodes.get(key);
    }

    let inSet = null;        // holds node + target array pointer (n.sets or n.setUser)
    let groupStack = [];     // capture nested group names for display context

    for (let i=0;i<L.length;i++){
      const raw = L[i];
      const line = raw.trim();
      if (!line){ inSet = null; continue; }

      // Handle Set / SetUser item lines (they often start with § and must NOT be treated as comments)
      if (inSet && (line.startsWith('§') || line.startsWith('#'))){
        const m = line.match(R_SET_ITEM);
        if (m){
          const [, key, rawVal] = m;
          inSet.target.push({ key: key.trim(), val: parseValue(rawVal.trim()) });
        }
        continue;
      }

      // Ignore pure comments outside Set blocks
      if (!inSet && line.startsWith('#')) continue;

      // GROUP start/end
      let m = line.match(R_GROUP_START);
      if (m){
        groupStack.push(m[1].trim());
        steps.push({ kind:'group_start', name:m[1].trim(), depth:groupStack.length });
        inSet = null; continue;
      }
      m = line.match(R_GROUP_END);
      if (m){
        const name = m[1].trim();
        steps.push({ kind:'group_end', name, depth:groupStack.length });
        groupStack.pop();
        inSet = null; continue;
      }

      // CREATE
      m = line.match(R_CREATE);
      if (m){
        const [, ui, variant, custom, id, typeId] = m;
        const n = ensureNode(ui.trim(), id);
        n.variant = (variant||'—').trim();
        n.customLabel = trimTildes(custom||'');
        n.typeId = typeId.trim();
        steps.push({ kind:'create', id, ui:ui.trim(), variant:n.variant, custom:n.customLabel, typeId:n.typeId, group:[...groupStack] });
        inSet = null; continue;
      }

      // DECLARE
      m = line.match(R_DECLARE);
      if (m){
        const [, kind, which, ui, id, tail] = m;
        const n = ensureNode(ui.trim(), id);
        const list = splitSocketList(tail);
        if (/Inputs/i.test(which))  n.sockets.in = list;
        else                        n.sockets.out = list;
        declares.push({ kind: which.toLowerCase(), nodeId:id, ui:ui.trim(), ports:list });
        steps.push({ kind:'declare', which:which.toLowerCase(), id, ui:ui.trim(), ports:list, group:[...groupStack] });
        inSet = null; continue;
      }

      // EXPOSE
      m = line.match(R_EXPOSE);
      if (m){
        const [, ui, id, sideGlyph, portName] = m;
        steps.push({ kind:'expose', id, ui:ui.trim(), side: sideGlyph==='○'?'output':'input', port: portName.trim(), group:[...groupStack] });
        inSet = null; continue;
      }

      // RENAME
      m = line.match(R_RENAME);
      if (m){
        const [, ui, id, newName] = m;
        const n = ensureNode(ui.trim(), id);
        n.customLabel = newName.trim();
        n.nameForUI = newName.trim() || ui.trim();
        steps.push({ kind:'rename', id, ui:ui.trim(), to:newName.trim(), group:[...groupStack] });
        inSet = null; continue;
      }

      // SET header
      m = line.match(R_SET_HDR);
      if (m){
        const [, ui, id] = m;
        const n = ensureNode(ui.trim(), id);
        inSet = { node:n, target:n.sets };
        steps.push({ kind:'set', id, ui:ui.trim(), items:n.sets, group:[...groupStack] });
        continue;
      }

      // SETUSER header
      m = line.match(R_SETUSER_HDR);
      if (m){
        const [, ui, id] = m;
        const n = ensureNode(ui.trim(), id);
        inSet = { node:n, target:n.setUser };
        steps.push({ kind:'setuser', id, ui:ui.trim(), items:n.setUser, group:[...groupStack] });
        continue;
      }

      // ADJUST
      m = line.match(R_ADJUST);
      if (m){
        const [, ui, id, key, rawVal] = m;
        const n = ensureNode(ui.trim(), id);
        n.adjust.push({ key:key.trim(), val: parseValue(rawVal.trim()) });
        steps.push({ kind:'adjust', id, ui:ui.trim(), key:key.trim(), val: parseValue(rawVal.trim()), group:[...groupStack] });
        inSet = null; continue;
      }

      // CONNECT
      m = line.match(R_CONNECT);
      if (m){
        const [, dotted, uiA, idA, outPort, uiB, idB, inPort] = m;
        links.push({ dotted: !!dotted, from:{ui:uiA.trim(), id:idA, port: normPort(outPort)}, to:{ui:uiB.trim(), id:idB, port: normPort(inPort)} });
        steps.push({ kind:'connect', dotted:!!dotted, srcId:idA, dstId:idB, srcUI:uiA.trim(), dstUI:uiB.trim(), srcPort:normPort(outPort), dstPort:normPort(inPort), group:[...groupStack] });
        inSet = null; continue;
      }

      // Section headers, version lines
      if (/^#\s*BNDL\s+v/i.test(line) || /^#\s*===/.test(line)) { inSet = null; continue; }

      // Unrecognized
      errors.push({ line:i+1, text: raw });
      inSet = null;
    }

    return { nodes, steps, links, declares, zones, errors };

    // utils
    function splitSocketList(txt){
      return txt.split(/\s*,\s*/).map(tok => tok.replace(/^○\s*|^⦿\s*/,'').trim());
    }
    function normPort(s){ return (s||'').trim(); }

    // Value parser
    function parseValue(raw){
      const txt = raw.trim();
      if (/^©.*©$/.test(txt)) return { kind:'string', value: unquote(txt).replace(/©©/g,'©') };
      const sentinels = [
        { k:'material',  re:/^❆(.*)❆$/ },
        { k:'object',    re:/^⊞(.*)⊞$/ },
        { k:'collection',re:/^✸(.*)✸$/ },
        { k:'image',     re:/^✷(.*)✷$/ },
        { k:'mesh',      re:/^⧉(.*)⧉$/ },
        { k:'curve',     re:/^𝒞(.*)𝒞$/ },
      ];
      const ang = parseAngleBrackets(txt);
      for (const s of sentinels){ const m = ang.match(s.re); if (m) return { kind:'datablock', type:s.k, name:m[1] }; }
      if (/^<\s*-?\d+(\.\d+)?\s*,/.test(txt)) return { kind:'tuple', value: parseTuple(txt) };
      if (/^<\s*(True|False)\s*>$/i.test(txt)) return { kind:'bool', value:/True/i.test(txt) };
      if (/^<\s*-?\d+(\.\d+)?([eE][+-]?\d+)?\s*>$/.test(txt)) return { kind:'number', value:+parseAngleBrackets(txt) };
      return { kind:'raw', value: parseAngleBrackets(txt) };
    }
  }

  /* -------------------- Rendering -------------------- */
  function render(ir){
    out.innerHTML = '';

    if (ir.errors.length){
      const div = document.createElement('div');
      div.className='err';
      div.innerHTML = `<h3>Unrecognized lines</h3><ul>${ir.errors.slice(0,200).map(e=>`<li><code>${e.line}</code> — ${escapeHtml(e.text)}</li>`).join('')}</ul>`;
      out.appendChild(div);
    }

    // Group Interface (Declare…)
    if (ir.declares.length){
      const det = block('Group Interface (Declare …)', false);
      const wrap = document.createElement('div'); wrap.className = 'kv';
      for (const d of ir.declares){
        const k = document.createElement('div'); k.className='key';
        k.textContent = `${d.which} • [ ${d.ui} #${d.id} ]`;
        const v = document.createElement('div'); v.className='val';
        v.textContent = d.ports.join(', ');
        wrap.appendChild(k); wrap.appendChild(v);
      }
      det.appendChild(wrap); out.appendChild(det);
    }

    // Steps
    const list = document.createElement('ol'); list.className = 'steps';
    out.appendChild(list);

    for (const st of ir.steps){
      const li = document.createElement('li'); li.className='step';
      const desc = document.createElement('div'); desc.className='step-desc';
      const card = document.createElement('div'); card.className='card';

      if (st.kind === 'group_start'){
        const dv = directive('📦', `Group: ${st.name}`); card.appendChild(dv);
        desc.textContent = `START GROUP ${st.name}`;
      } else if (st.kind === 'group_end'){
        const dv = directive('📦', `End Group: ${st.name}`); card.appendChild(dv);
        desc.textContent = `END GROUP ${st.name}`;
      }
      else if (st.kind === 'create'){
        desc.textContent = `Create [ ${st.ui} | ${st.variant} | ] #${st.id} ; type=${st.typeId}`;
        card.appendChild(renderNode(st.ui, st.variant, st.id));
      }
      else if (st.kind === 'declare'){
        desc.textContent = `Declare ${st.which} [ ${st.ui} #${st.id} ]`;
        const chips = document.createElement('div'); chips.className='chips';
        for (const p of st.ports){ const c=document.createElement('div'); c.className='chip'; c.textContent=p; chips.appendChild(c); }
        card.appendChild(chips);
      }
      else if (st.kind === 'expose'){
        desc.textContent = `Expose [ ${st.ui} #${st.id} ] ${st.side==='output'?'○':'⦿'} ${st.port}`;
        card.appendChild(keyvals([['Side', st.side], ['Port', st.port]]));
      }
      else if (st.kind === 'rename'){
        desc.textContent = `Rename [ ${st.ui} #${st.id} ] → ${st.to || '(empty label)'}`;
        card.appendChild(keyvals([['New Label', st.to]]));
      }
      else if (st.kind === 'set' || st.kind === 'setuser'){
        const title = `${st.kind==='set'?'Set':'SetUser'} [ ${st.ui} #${st.id} ]`;
        desc.textContent = title;
        const items = st.items.map(it => [it.key, prettyVal(it.val)]);
        const kvc = keyvalsCollapsible(title, items, {threshold:12, maxHeight:280});
        card.appendChild(kvc);
      }
      else if (st.kind === 'adjust'){
        desc.textContent = `Adjust [ ${st.ui} #${st.id} ]`;
        card.appendChild(keyvals([[st.key, prettyVal(st.val)]]));
      }
      else if (st.kind === 'connect'){
        desc.textContent = `Connect${st.dotted?'⋯':''} [ ${st.srcUI} #${st.srcId} ] ○ ${st.srcPort} → [ ${st.dstUI} #${st.dstId} ] ⦿ ${st.dstPort}`;
        const row = renderConnectRow(st, ir);
        card.appendChild(row);
        requestAnimationFrame(() => drawWireForRow(row));
      }
      else{
        desc.textContent = st.kind;
        card.textContent = JSON.stringify(st);
      }
      li.appendChild(desc); li.appendChild(card); list.appendChild(li);
    }
  }

  /* ------ small DOM helpers that were missing in prior build ------ */
function block(title, open = true){
  const det = document.createElement('details');
  det.className = 'block';
  det.open = !!open;
  const sum = document.createElement('summary');
  sum.textContent = title;
  det.appendChild(sum);
  return det;
}


  function renderNode(ui, variant, id){
    const wrap = document.createElement('div'); wrap.className='node';
    const hdr = document.createElement('div'); hdr.className='hdr';
    hdr.style.background = headerColor(ui);
    hdr.textContent = `${ui}${variant && variant!=='—' ? ' — '+variant : ''}  #${id}`;
    const body = document.createElement('div'); body.className='body';
    const ports = document.createElement('div'); ports.className='ports';
    const left = document.createElement('div'); left.className='left';
    const right = document.createElement('div'); right.className='right';
    ports.appendChild(left); ports.appendChild(right);
    body.appendChild(ports); wrap.appendChild(hdr); wrap.appendChild(body);
    return wrap;
  }

  function renderConnectRow(st, ir){
    const row = document.createElement('div'); row.className='row';
    row.dataset.srcKey = `#${st.srcId}`; row.dataset.srcPort = st.srcPort;
    row.dataset.dstKey = `#${st.dstId}`; row.dataset.dstPort = st.dstPort;
    row.dataset.dotted = st.dotted ? '1':'0';

    const left = renderNode(st.srcUI, '', st.srcId);
    const spacer = document.createElement('div'); spacer.className='spacer';
    const right = renderNode(st.dstUI, '', st.dstId);

    const lp = pill('out', st.srcPort); lp.dataset.nodeKey = `#${st.srcId}`; lp.dataset.portName = st.srcPort; lp.dataset.side='out';
    const rp = pill('in',  st.dstPort); rp.dataset.nodeKey = `#${st.dstId}`; rp.dataset.portName = st.dstPort; rp.dataset.side='in';
    left.querySelector('.right').appendChild(lp);
    right.querySelector('.left').appendChild(rp);

    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.classList.add('wire-layer');

    row.appendChild(left); row.appendChild(spacer); row.appendChild(right); row.appendChild(svg);
    return row;
  }

  function pill(side, name){
    const p = document.createElement('div'); p.className='port';
    const dot = document.createElement('div'); dot.className='dot unknown';
    const label = document.createElement('div'); label.textContent = name;
    if (side==='in'){ p.appendChild(dot); p.appendChild(label); }
    else{ p.appendChild(label); p.appendChild(dot); }
    return p;
  }

function keyvals(arr){
  const grid = document.createElement('div'); grid.className='kv';
  for (const [k,v] of arr){
    const kd = document.createElement('div'); kd.className='key'; kd.textContent = k;
    const vd = document.createElement('div'); vd.className='val'; vd.textContent = (typeof v==='string') ? v : JSON.stringify(v);
    grid.appendChild(kd); grid.appendChild(vd);
  }
  return grid;
}

function keyvalsCollapsible(title, arr, opts={}){
  const threshold   = opts.threshold ?? 12;
  const maxHeightPx = opts.maxHeight ?? 280;

  // Outer details (collapsed by default)
  const det = document.createElement('details');
  det.className = 'kv-collapsible';
  det.open = false;

  // Summary row (single line)
  const sum = document.createElement('summary');
  const t   = document.createElement('span'); t.className = 'kv-title';
  t.textContent = `Node value settings — ${title}`;
  const c   = document.createElement('span'); c.className = 'kv-count';
  c.textContent = `${arr.length} item${arr.length===1?'':'s'}`;
  sum.appendChild(t); sum.appendChild(c);
  det.appendChild(sum);

  // Content: scrolled grid + mini controls (attached on first open)
  const wrap = document.createElement('div'); wrap.className = 'kv-wrap';
  const grid = document.createElement('div'); grid.className = 'kv scrolled';
  grid.style.maxHeight = `${maxHeightPx}px`;

  for (const [k,v] of arr){
    const kd = document.createElement('div'); kd.className='key'; kd.textContent = k;
    const vd = document.createElement('div'); vd.className='val';
    vd.textContent = (typeof v==='string') ? v : JSON.stringify(v);
    grid.appendChild(kd); grid.appendChild(vd);
  }

  const fade = document.createElement('div'); fade.className='kv-fade';
  const controls = document.createElement('div'); controls.className='kv-controls';
  const summary  = document.createElement('div'); summary.className='kv-summary';
  summary.textContent = (arr.length > threshold)
    ? `Showing first ${threshold} of ${arr.length}`
    : `${arr.length} items`;
  const btn = document.createElement('button'); btn.className='mini-btn'; btn.type='button';
  btn.textContent = 'Show all';

  let expandedAll = false;
  btn.addEventListener('click', ()=>{
    expandedAll = !expandedAll;
    if (expandedAll){
      grid.classList.remove('scrolled');
      grid.style.maxHeight = 'none';
      fade.style.display = 'none';
      btn.textContent = 'Collapse';
      summary.textContent = `${arr.length} items`;
    }else{
      grid.classList.add('scrolled');
      grid.style.maxHeight = `${maxHeightPx}px`;
      fade.style.display = '';
      btn.textContent = 'Show all';
      summary.textContent = (arr.length > threshold)
        ? `Showing first ${threshold} of ${arr.length}`
        : `${arr.length} items`;
      grid.scrollTop = 0;
    }
  });

  controls.appendChild(summary);
  if (arr.length > threshold) controls.appendChild(btn);

  // Lazily attach inner content on first open
  let attached = false;
  det.addEventListener('toggle', ()=>{
    if (det.open && !attached){
      wrap.appendChild(grid);
      if (arr.length > threshold) wrap.appendChild(fade);
      wrap.appendChild(controls);
      det.appendChild(wrap);
      attached = true;
    }
  });

  return det;
}


  function directive(icon, text){
    const d = document.createElement('div'); d.className='directive';
    const i = document.createElement('div'); i.className='icon'; i.textContent = icon;
    const t = document.createElement('div'); t.className='text'; t.textContent = text;
    d.appendChild(i); d.appendChild(t); return d;
  }

  function prettyVal(v){
    if (!v) return '';
    if (v.kind==='tuple') return `<${v.value.join(', ')}>`;
    if (v.kind==='datablock') return `${v.type}:${v.name}`;
    return String(v.value ?? v);
  }

  function escapeHtml(s){ return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  /* ------- Wire drawing (per row) ------- */
  function drawWireForRow(row){
    const wire = row.querySelector('.wire-layer'); if(!wire) return;
    while (wire.firstChild) wire.removeChild(wire.firstChild);
    const rb = row.getBoundingClientRect();
    wire.setAttribute('viewBox', `0 0 ${rb.width} ${rb.height}`);
    wire.setAttribute('width', rb.width); wire.setAttribute('height', rb.height);

    function line(x1,y1,x2,y2, dashed){
      const L = document.createElementNS('http://www.w3.org/2000/svg','line');
      L.setAttribute('x1', x1); L.setAttribute('y1', y1);
      L.setAttribute('x2', x2); L.setAttribute('y2', y2);
      L.setAttribute('stroke', socketColor('vector'));
      if (dashed) L.setAttribute('stroke-dasharray', '6 6');
      L.setAttribute('stroke-width', '4'); L.setAttribute('stroke-linecap', 'round'); wire.appendChild(L);
    }

    const src = row.querySelector(`.port[data-side="out"]`);
    const dst = row.querySelector(`.port[data-side="in"]`);
    if (!src || !dst) return;

    const sb = src.getBoundingClientRect(); const db = dst.getBoundingClientRect();
    const sx = (sb.left + sb.width  - 6) - rb.left;
    const sy = (sb.top  + sb.height/2) - rb.top;
    const dx = (db.left + 6) - rb.left;
    const dy = (db.top  + db.height/2) - rb.top;

    line(sx, sy, dx, dy, row.dataset.dotted==='1');
  }

  /* ------- File + parse actions ------- */
  $('#fileInput').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const txt = await f.text();
    src.value = txt;
    // Auto-parse immediately after load
    const ir = parseBNDL(src.value);
    render(ir);
    requestAnimationFrame(() => document.querySelectorAll('.row').forEach(drawWireForRow));
    // Reveal the source panel so the user sees what loaded
    document.querySelector('#srcWrap').open = true;
  });


  $('#parseBtn').addEventListener('click', ()=>{
    const txt = src.value.trim() ? src.value : '';
    const ir = parseBNDL(txt);
    render(ir);
    requestAnimationFrame(() => document.querySelectorAll('.row').forEach(drawWireForRow));
  });

  // Playthrough controls (visual only)
  let ptState = { enabled:false, idx:0 };
  function refreshPT(){
    const items = [...document.querySelectorAll('.step')];
    items.forEach((el,i)=>{
      el.classList.toggle('dim', ptState.enabled && i>ptState.idx);
      el.classList.toggle('current', ptState.enabled && i===ptState.idx);
    });
    $('#ptToggle').textContent = `Playthrough: ${ptState.enabled?'On':'Off'}`;
    requestAnimationFrame(() => document.querySelectorAll('.row').forEach(drawWireForRow));
  }
  $('#ptToggle').addEventListener('click', ()=>{ ptState.enabled = !ptState.enabled; ptState.idx = 0; refreshPT(); });
  $('#ptPrev').addEventListener('click', ()=>{ if(!ptState.enabled) return; ptState.idx = Math.max(0, ptState.idx-1); refreshPT(); });
  $('#ptNext').addEventListener('click', ()=>{ if(!ptState.enabled) return; const N=document.querySelectorAll('.step').length; ptState.idx = Math.min(N-1, ptState.idx+1); refreshPT(); });
  $('#ptReset').addEventListener('click', ()=>{ ptState.idx = 0; refreshPT(); });

  // start empty (you’ll paste/load a BNDL)
  src.value = '';

  if (src.value.trim()) {
  const ir = parseBNDL(src.value);
  render(ir);
  requestAnimationFrame(() => document.querySelectorAll('.row').forEach(drawWireForRow));
}

})();
</script>
</body>
</html>
